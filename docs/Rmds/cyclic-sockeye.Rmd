```{r cylcic-sockeye-setup, include=FALSE}
knitr::opts_knit$set(unnamed.chunk.label = "cyclic-sockeye-")
knitr::opts_chunk$set(echo = TRUE, comment=NA, cache=FALSE, tidy.opts=list(width.cutoff=60), tidy=TRUE, fig.align='center', out.width='80%', message=FALSE, warning=FALSE)
```

# Modeling changing sockeye seasonality {#chap-cyclic-sockeye}
\chaptermark{Cyclic sockeye}

```{r}
library(atsalibrary)
library(ggplot2)
library(MARSS)
```

In this chapter we will use DLMs to account for cyclicity in Bristol Bay sockeye spawner escapement (returning spawners minus catch).

```{r echo=FALSE}
knitr::include_graphics("images/BB_sockeye_rivers_inset.png")
# ![](images/BB_sockeye_rivers_inset.png)
```

## Analysis goal

Our goal is to look for the underlying level (trends) in the rivers and studying whether there is evidence of synchronicity (correlated trend changes across rivers). In looking at the data, we have a couple problems. 

1. There are strong cycles in the annual data due to the life cycle of sockeye which return 4-5 years after their brood year (year they were spawned). But unfortunately the cycles do not occur regularly every 5 years. Sockeye produce cycles that are 5 years apart but the cycle might break down for a year or two and then restart after a year or two. Thus the cycle appears to shift.
2. The amplitude of the cycle changes over time.

Both of these will cause us problems when we try to estimate a stochastic level.

```{r echo=FALSE}
ggplot(sockeye, aes(x=brood_year, y=log(spawners))) + geom_line() + facet_wrap(~region, scales="free_y") + ggtitle("log spawners")
```

ACF of the spawners showing the 5-year cycle in most of the rivers.
```{r echo=FALSE}
a <- tapply(sockeye$spawners, sockeye$region, function(x){acf(x, na.action=na.pass, plot=FALSE, lag=10)$acf[,1,1]})
aa <- data.frame(acf=Reduce(c, a),
                    region=rep(names(a), each=11),
                    lag=rep(0:10, length(names(a))))
ggplot(aa, aes(x=lag, y=acf)) +
       geom_bar(stat = "identity", position = "identity") + geom_vline(xintercept=5)+
  facet_wrap(~region)+ggtitle("ACF")
```

## Modeling the cycle

As discussed in Chapter \@ref(chap-seasonal-dlm) in the covariates chapter, we can model changes in seasonality with a DLM with sine and cosine covariates. Here is a DLM model with the level and season modeled as a random walk.

$$\begin{bmatrix}x \\ \beta_1 \\ \beta_2 \end{bmatrix}_t = \begin{bmatrix}x \\ \beta_1 \\ \beta_2 \end{bmatrix}_{t-1} + \begin{bmatrix}w_1 \\ w_2 \\ w_3 \end{bmatrix}_t$$
$$y_t = \begin{bmatrix}1& \sin(2\pi t/p)&\cos(2\pi t/p)\end{bmatrix} \begin{bmatrix}x \\ \beta_1 \\ \beta_2 \end{bmatrix}_t + v_t$$

We can fit the model to the Kvichak River log spawner data and estimate the $\beta$'s and stochastic level ($x$). This is annual data so what does $p$ mean? $p$ is the time steps between peaks. For sockeye that is 5 years. So we set $p=5$. If $p$ were changing, that would cause problems, but it is not for these data (which you can confirm by looking at the ACF for different parts of the time series).

### Set up the data

```{r}
river <- "KVICHAK"
df <- subset(sockeye, region==river)
yt <- log(df$spawners)
TT <- length(yt)
p <- 5
```

### Specify the $\mathbf{Z}$ matrix

$\mathbf{Z}$ is time-varying and we set this up with an array with the 3rd dimension being time.

```{r cylcic-sockeye-Z1}
Z <- array(1, dim=c(1,3,TT))
Z[1,2,] <- sin(2*pi*(1:TT)/p)
Z[1,3,] <- cos(2*pi*(1:TT)/p)
```

### Specify the model list

Then we make our model list. We need to set $\mathbf{A}$ since `MARSS()` doesn't like the default value of `scaling` when $\mathbf{Z}$ is time-varying.
```{r cylcic-sockeye-mod.list1}
mod.list <- list(
  U = "zero",
  Q = "diagonal and unequal",
  Z = Z,
  A = "zero")
```

### Fit the model

When we fit the model we need to give `MARSS()` initial values for `x0`. It cannot come up with default ones for this model. It doesn't really matter what you pick.
```{r}
m <- dim(Z)[2]
fit <- MARSS(yt, model=mod.list, inits=list(x0=matrix(0,m,1)))
```

### Plot the output

The $\beta_1$ estimate is State X2 and $\beta_2$ is State X3. The estimates match what we put into the simulated data.

```{r echo=FALSE}
plot(fit, plot.type="xtT")
```

We can plot our cycle estimates and see that the peak has shifted over time. The peak has not been regularly every 5 years.

```{r echo=FALSE}
beta1s = fit$states[2,]
beta2s = fit$states[3,]
value = beta1s*sin(2*pi*(1:TT/p))+beta2s*cos(2*pi*(1:TT)/p)

plot(1:TT, value, type="l",xlab="", ylab="beta1*sin() + beta2*cos()")
abline(v=seq(0,TT,p), col="grey")
title(river)
```

Let's look at the other rivers. Write a function to do the fit.

```{r}
fitriver <- function(river, p=5){ 
df <- subset(sockeye, region==river)
yt <- log(df$spawners)
TT <- length(yt)
Z <- array(1, dim=c(1,3,TT))
Z[1,2,] <- sin(2*pi*(1:TT)/p)
Z[1,3,] <- cos(2*pi*(1:TT)/p)
mod.list <- list(
  U = "zero",
  Q = "diagonal and unequal",
  Z = Z,
  A = "zero")
fit <- MARSS(yt, model=mod.list, inits=list(x0=matrix(0,3,1)), silent=TRUE)
return(fit)
}
```

The make a list with all the fits.
```{r}
fits <- list()
for(river in names(a)){
  fits[[river]] <- fitriver(river)
}
```

Create a data frame of the amplitude of the cycle ($\sqrt{\beta_1^2+\beta_2^2}$) and the stochastic level ($x$).
```{r}
dfz <- data.frame()
for(river in names(a)){
  fit <- fits[[river]]
  tmp <- data.frame(amplitude = sqrt(fit$states[2,]^2+fit$states[3,]^2),
                    trend = fit$states[1,],
                    river=river,
                    brood_year=subset(sockeye, region==river)$brood_year)
  dfz <- rbind(dfz, tmp)
}
```

Plot of the amplitude of the cycles.  All the rivers were analyzed independently. It certainly looks like there are common patterns in the amplitude of the cycles with many showing a steady decline in amplitude. Note the counts were not decreasing so this is not due to fewer spawners.
```{r}
ggplot(dfz, aes(x=brood_year, y=amplitude)) + 
  geom_line() + 
  facet_wrap(~river, scales="free_y") + 
  ggtitle("Cycle Amplitude")
```

Plot of the stochastic level. Again all the rivers were analyzed independently. It certainly looks like there are common patterns in the trends. In the next step, we can test this.
```{r}
ggplot(dfz, aes(x=brood_year, y=trend)) + 
  geom_line() + 
  facet_wrap(~river, scales="free_y") + 
  ggtitle("Stochastic Level")
```


## Multivariate DLM
